<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>picker</title>
    <style type="text/css">

        .picker-reset {
            font-size: 15px;
            color: #4a98ff;
            float: right;
            cursor: pointer;
        }

        .picker-dialog {
            /*left: 42px;*/
            /*top: 52px;*/
            position: absolute;
            border: 1px solid #878787;
            min-height: 110px;
            min-width: 400px;
            display: inline-block;
        }

        .picker-dialog a {
            text-decoration: none;
        }

        .picker-dialog-tab {
            padding: 4px;
            height: 28px;
            background-color: #c9c9c9;
        }

        .picker-dialog-tab > a {
        }

        .picker-dialog-container > a {
            margin: 0px 8px;
            font-size: 14px;
            white-space: nowrap;
        }

        .selected {
            background-color: #ffffff;
            color: #30c7ff;
        }
    </style>
</head>
<body>
<div height="200px" style="background-color: #878787;">ssss</div>
<span height="200px" style="background-color: #878787;">ssss</span>
<input type="text" name="target" width="100%" id="picker">
<!--<div class="picker-dialog">-->
    <!--<div class="picker-dialog-tab">-->
        <!--<a href="#" data-id="1">一级菜单</a>-->
        <!--<a href="#" class="selected">二级菜单</a>-->
        <!--<span href="javascript:void(0);" class="picker-reset">清空</span>-->
    <!--</div>-->
    <!--<div class="picker-dialog-container">-->
        <!--<a href="#">北京</a> <a href="#">成都</a>-->
    <!--</div>-->
<!--</div>-->
<span>fffff</span>
</body>
</html>
<script type="text/javascript" src="../js/jquery-3.3.1.js"></script>
<script type="text/javascript">
    EventTarget.prototype.on = function (type, ...arg) {
        let str, data, callback;
        arg.forEach((item) => {
            //str要么是一个false要么是一个字符串
            typeof item == "string" ? str = item : item.toString() == "[object Object]" ? data = item : typeof item == "function" ? callback = item : null;
        });

        function run(e) {
            if (data) e.data = data;
            if (str) {
                if (e.target.tagName == str.toUpperCase()) {
                    callback && callback.call(e.target, e)
                }
            } else {
                callback && callback.call(this, e);
            }
        }

        this.addEventListener(type, run);
    };

    function addNewStyle(styleId, newStyle) {
//        var id,data,callback;
//        args.forEach((item)=>{
//            //str要么是一个false要么是一个字符串
//            typeof item=="string"?str=item:item.toString()=="[object Object]"?data=item: typeof item=="function"?callback=item:null;
//        });
        var styleElement = document.getElementById(styleId);

        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.type = 'text/css';
            styleElement.id = styleId;
            document.getElementsByTagName('head')[0].appendChild(styleElement);
        }

        styleElement.appendChild(document.createTextNode(newStyle));
    }

    function doSth(data, id, pid) {
        var ids = new Set();
        var pids = new Set();
        for (var item of data) {
            ids.add(item[id]);
            pids.add(item[pid]);
        }
        for (var val of ids) {
            pids.delete(val);
        }
        var result = new Array();
        for (var item of data) {
            if (pids.has(item[pid]))
                result.push(item);
        }
        return result;
    }

    function getData(resource, key, value) {
        var result = new Array();
        for (let item of resource) {
            if (item[key] == value)
                result.push(item);
        }
        return result;
    }

  function loadOption($container,datas){
        $container.html('');
      for (let obj of datas) {
          $container.append('<a href="#">' + obj["name"] + '</a>');
          $container.find("a").last().prop("data",obj);
      }
  }

</script>
<script type="text/javascript">


    $.fn.Chooser = function (resource, option) {

        var defaults = {
            styleId: "style_pikcer",
            id:'id',
            pid:'pid',
            name:'name',
            value:'value',
            resource:null
        };
        var htm = '';
        $.extend(defaults, option);
        defaults.resource=resource;
        htm = '<div class="picker-dialog">' +
            '<div class="picker-dialog-tab">' +
            '<span href="javascript:void(0);" class="picker-reset">清空</span>' +
            '</div>' +
            '<div class="picker-dialog-container">' +
            '</div>' +
            '</div>';
        this.after(htm);

        //事件
        var $dialog = this.next("div.picker-dialog");
            $dialog.css("left",this.offset().left);
            $dialog.css("top",this.offset().top + this.outerHeight());
        var $tab = $dialog.find("div").eq(0);
        var $container = $dialog.find("div").eq(1);
        if ($dialog.length === 1) {
            //tab点击
            $tab.on("click", "a", function () {
                var $e = $(event.target);
                if ($e.hasClass('selected')) return;
                $e.addClass('selected');
                $e.next("a").remove();
                var datas = getData(dataArray, "pid", $e.attr("data-id"));
             loadOption($container,datas);

            });
            //item点击
            $container.on("click",'a',function(){
                var $e = $(event.target);
                var data=$e.prop("data");
                var id=data[defaults.id];
                var datas= getData(defaults.resource,defaults.pid,id);
                if(datas.length===0){
                    $dialog.hide()
                }else{
                   loadOption($container,datas);
                }
            });
        } else {
            console.error("未成功初始化选择框！");
        }


        var lv1 = doSth(dataArray, "id", "pid");
       loadOption($container,lv1);


        addNewStyle('.box {height: 100px !important;}');
        addNewStyle('.hidden {display: none;}');




    }

    var dataArray = new Array();
    dataArray.push({id: 1, pid: 0, name: "北京"});
    dataArray.push({id: 11, pid: 1, name: "朝阳区"});
    dataArray.push({id: 2, pid: 0, name: "四川"});
    dataArray.push({id: 21, pid: 2, name: "成都"});
    dataArray.push({id: 211, pid: 21, name: "武侯区"});
    dataArray.push({id: 212, pid: 21, name: "锦江区"});
    dataArray.push({id: 22, pid: 2, name: "自贡"});
    dataArray.push({id: 23, pid: 2, name: "绵阳"});


    $("#picker").Chooser(dataArray, {
        id: "id",
        pid: "pid",
        display: "name",
    });


</script>


